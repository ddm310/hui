<!DOCTYPE html>
<html lang="ru">

<head>
  <script>
    window.addEventListener('beforeunload', function (e) {
      e.preventDefault();
      e.returnValue = '';
    });
  </script>

  <meta charset="UTF-8">
  <title>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f0f0f0;
    }

    input,
    textarea,
    button {
      display: block;
      margin: 10px 0;
      width: 100%;
    }

    img {
      max-width: 100%;
      margin-top: 20px;
    }

    pre {
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      overflow-x: auto;
    }
  </style>
</head>

<body>
  <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ WebUI</h1>

  <label for="prompt">–ü—Ä–æ–º–ø—Ç (–æ–ø–∏—Å–∞–Ω–∏–µ):</label>
  <textarea id="prompt" rows="3">the open palm of a man</textarea>

  <label for="negative">–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç:</label>
  <textarea id="negative" rows="2">no background</textarea>

  <label for="steps">–®–∞–≥–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</label>
  <input type="number" id="steps" value="10" min="1" max="100">

  <label for="cfg">CFG Scale:</label>
  <input type="number" id="cfg" value="7" step="0.5" min="1" max="20">

  <button type="button" onclick="generate(event)">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
  <label for="imageUpload">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
  <input type="file" id="imageUpload" accept="image/*">
  <button type="button" onclick="modifyImage(event)">–ò–∑–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>


  <div id="result"></div>
  <button id="downloadBtn" style="display:none;">–°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
  <pre id="debug"></pre>

  <script>
    let interval = null;
    let lastImageData = null;

    async function generate(event) {
      event.preventDefault();

      if (interval) {
        clearInterval(interval);
        interval = null;
      }

      document.getElementById('result').innerHTML = '';
      document.getElementById('debug').textContent = '';
      document.getElementById('downloadBtn').style.display = 'none';

      console.log("üü° –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞—Å—å...");

      const prompt = document.getElementById('prompt').value;
      const negative = document.getElementById('negative').value;
      const steps = parseInt(document.getElementById('steps').value);
      const cfg = parseFloat(document.getElementById('cfg').value);

      const payload = {
        prompt: prompt,
        negative_prompt: negative,
        steps: steps,
        cfg_scale: cfg,
        width: 512,
        height: 512,
        save_images: true
      };

      console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", payload);
      document.getElementById('debug').textContent += "üì§ –ó–∞–ø—Ä–æ—Å:\n" + JSON.stringify(payload, null, 2) + "\n";

      let progress = 0;
      interval = setInterval(() => {
        progress += 1;
        console.log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ... ${progress}s`);
      }, 1000);

      try {
        console.log("üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ API...");

        const response = await fetch('http://127.0.0.1:7860/sdapi/v1/txt2img', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        console.log("üì° –û—Ç–≤–µ—Ç —Å—Ç–∞—Ç—É—Å:", response.status);

        const raw = await response.text();
        console.log("üìÑ –°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç:", raw);
        clearInterval(interval);
        interval = null;

        let data;
        try {
          data = JSON.parse(raw);
        } catch (e) {
          console.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON:", e);
          document.getElementById('debug').textContent += "\n‚ùå –û—Ç–≤–µ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è JSON:\n" + raw;
          return false;
        }

        console.log("‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:", data);
        document.getElementById('debug').textContent += "\n‚úÖ –û—Ç–≤–µ—Ç:\n" + JSON.stringify(data, null, 2);

        if (data.images && data.images.length > 0 && data.images[0]) {
          const image = data.images[0];
          lastImageData = image;

          // üëâ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ localStorage
          localStorage.setItem("lastGeneratedImage", image);

          document.getElementById('result').innerHTML = `<img src="data:image/png;base64,${image}">`;
          document.getElementById('downloadBtn').style.display = 'block';
        } else {
          console.warn("‚ö†Ô∏è –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–µ.");
          document.getElementById('result').innerHTML = `<p style="color:red;">‚ö†Ô∏è –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–µ –æ—Ç WebUI.</p>`;
        }
      } catch (error) {
        clearInterval(interval);
        interval = null;
        console.error("‚ùå –û—à–∏–±–∫–∞:", error);
        document.getElementById('result').innerHTML = `<p style="color:red;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}</p>`;
        document.getElementById('debug').textContent += "\n‚ùå –û—à–∏–±–∫–∞:\n" + error.message;
      }

      return false;
    }

    document.getElementById('downloadBtn').addEventListener('click', () => {
      if (!lastImageData) return;
      const a = document.createElement('a');
      a.href = `data:image/png;base64,${lastImageData}`;
      a.download = 'generated.png';
      a.click();
    });

    window.addEventListener('error', function (e) {
      console.error("üåã –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:", e.message);
    });

    // üëâ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener("DOMContentLoaded", () => {
      const saved = localStorage.getItem("lastGeneratedImage");
      if (saved) {
        lastImageData = saved;
        document.getElementById('result').innerHTML = `<img src="data:image/png;base64,${saved}">`;
        document.getElementById('downloadBtn').style.display = 'block';
        console.log("‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ localStorage");
      }
    });
    async function modifyImage(event) {
      event.preventDefault();

      const fileInput = document.getElementById('imageUpload');
      if (!fileInput.files || fileInput.files.length === 0) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏!");
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = async function () {
        const base64Image = reader.result.split(",")[1]; // —É–±–∏—Ä–∞–µ–º data:image/png;base64,

        const prompt = document.getElementById('prompt').value;
        const negative = document.getElementById('negative').value;
        const steps = parseInt(document.getElementById('steps').value);
        const cfg = parseFloat(document.getElementById('cfg').value);

        const payload = {
          prompt: prompt,
          negative_prompt: negative,
          steps: steps,
          cfg_scale: cfg,
          width: 512,
          height: 512,
          init_images: [base64Image],   // üëà –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          denoising_strength: 0.6,      // üëà —Å—Ç–µ–ø–µ–Ω—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (0.3 = –º–∞–ª–æ, 0.8 = —Å–∏–ª—å–Ω–æ)
          save_images: true
        };

        try {
          const response = await fetch('http://127.0.0.1:7860/sdapi/v1/img2img', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const raw = await response.text();
          let data = JSON.parse(raw);

          if (data.images && data.images.length > 0 && data.images[0]) {
            const image = data.images[0];
            lastImageData = image;

            // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem("lastGeneratedImage", image);

            document.getElementById('result').innerHTML = `<img src="data:image/png;base64,${image}">`;
            document.getElementById('downloadBtn').style.display = 'block';
          } else {
            document.getElementById('result').innerHTML = `<p style="color:red;">‚ö†Ô∏è –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–µ –æ—Ç WebUI.</p>`;
          }
        } catch (error) {
          console.error("‚ùå –û—à–∏–±–∫–∞:", error);
          document.getElementById('result').innerHTML = `<p style="color:red;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}</p>`;
        }
      };

      reader.readAsDataURL(file);
    }

  </script>
</body>

</html>